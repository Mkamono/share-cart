version: "3"

env:
  POSTGRES_URL:
    sh: echo postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@$POSTGRES_HOST/$POSTGRES_DB?sslmode=disable
  SCHEMA_FILES:
    sh: find docs/atlas -type f | sed 's|^|file://|' | paste -sd ","

tasks:
  dev:
    cmds:
      - task: generate
      - task: graph

  generate:
    cmd: ogen --package oas --target app/oas --clean docs/openapi.yaml
    sources:
      - docs/openapi.yaml

  graph:
    cmd: godepgraph -o .,api -s . | dot -Tpng -o ./docs/dependency.png # cspell:disable-line
    sources:
      - ./**/*.go

  plan:
    cmd: atlas schema apply -u $POSTGRES_URL --to $SCHEMA_FILES --dry-run

  apply:
    cmds:
      - atlas schema apply -u $POSTGRES_URL --to $SCHEMA_FILES
      - task: tbls
      - task: sqlboiler

  sqlboiler:
    cmd: sqlboiler psql

  tbls:
    dir: docs
    cmd: tbls doc $POSTGRES_URL --rm-dist -c tbls/.tbls.yaml
